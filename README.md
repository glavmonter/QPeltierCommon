# QPeltierCommon

Генераторы кода и настройки для контроллера термоэлектрического преобразователя.

# Использование

Клонируем репозиторий как сабмодуль в *common*. Подключаем скрипты cmake:

```
include(common/cmake/macro-add-python.cmake)
include(common/cmake/function-generate-commands.cmake)
```

Ищем Python и создаём виртуальное окружение, генерируем хедер с командами:

```
add_python_venv(${CMAKE_SOURCE_DIR}/common/requirements.txt)
generate_commands(${CMAKE_SOURCE_DIR}/common/commands.json)
```

Добавляем сгенерированный хедер и python к зависимостям:

```
add_executable(${TARGET_NAME} ${COMMANDS_SRC})
```

В коде используем сгенерированный хедер:

```cpp
#include <commands.hpp>
```

# Протокол общения с устройством

Для обмена использован протокол последовательный SLIP, его вариант Wake.

Коды команд в диапазоне от 0 до 127.

Команды управления:

| Команда               | Код   | Размер. tx/rx | Описание |
| :-------------------- | :---: | :----: | :------- |
| Nop                   | 0     | \*/0   | Нет операции, делать ничего |
| VersionGet            | 1     | 0/8    | Версия устройства |
| SensorGetSet          | 5     | 1/1    | Вариант сенсора температуры |
| CurrentPidGetSet      | 6     | 5/5    | Управление регулятором тока |
| TemperaturePidGetSet  | 7     | 5/5    | Управление регулятором температуры |
| WorkModeSetGet        | 8     | 1/1    | Управление режимом работы |
| CurrentStabGetSet     | 9     | 4/4    | Управление уставкой тока |
| TemperatureStabGetSet | 10    | 4/4    | Управление уставкой температуры |
| Telemetry             | 85    | -/\*   | Телеметрия |
| VoltageGetSet         | 127   | 4/4    | Управление выходным напряжением в % от питания |
|  |  |  |  |
|  |  |  |  |
|  |  |  |  |
|  |  |  |  |
|  |  |  |  |

Размер в таблице указывается в следующем формате: "количество байт от ПЭВМ к устройству" / "количество байт от устройства у ПЭВМ". '\*' - Любой размер, `-` - нет ответа или ответ запрещен.

Команды \*GetSet позволяют запросить в устройстве соответсвующее значение. Для этого посылается команда без полезных данных. Например для команды *SensorGeSet* запрос будет будет без данных, а устройство ответит с 1 байтом в выбранным сенсором.

## *VersionGet* - запрос версии устройства

Запрашивает версию устройства. Ответ: два uint32_t, младший - версия железа, старший - версия микропрограммы.

## *SensorGetSet* - Управление сенсором температуры

## *CurrentPidGetSet* - Управление регулятором тока

## *TemperaturePidGetSet* - Управление регулятором температуры

## *WorkModeSetGet* - Управление режимом работы

## *CurrentStabGetSet* - Управление уставкой тока

## *TemperatureStabGetSet* - Управление уставкой температуры

## *Telemetry* - Телеметрия

## *VoltageGetSet* - управление выходным напряжением

Отладочная команда для режима Debug. Устанавливает и считывает выходное напряжение на клеммах ТЭП в процентах от питающего напряжение. Передаём и принимаем тип float, 4 байта.

